{"posts":[{"title":"ElasticSearchå®‰è£…å’ŒåŸºäºSpringbootä½¿ç”¨","content":"å®‰è£… 1. ä¸‹è½½å®‰è£…åŒ… æ‰“å¼€ https://www.elastic.co/cn/downloads/elasticsearch å®˜ç½‘ï¼Œé€‰æ‹©å¯¹åº”å¹³å°çš„å®‰è£…åŒ…è¿›è¡Œä¸‹è½½ 2.è§£å‹ç¼©ä¸‹è½½çš„å®‰è£…åŒ… tar -zxvf ./elasticsearch-7.8.0-linux-x86_64.tar.gz -C /usr/local 3.åˆ›å»ºesuserç”¨æˆ· å› ä¸º elasticsearch ä¸èƒ½ä½¿ç”¨ root ç”¨æˆ·å¯åŠ¨ï¼Œå› æ­¤éœ€è¦å¦è¡Œæ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œç”¨äºå¯åŠ¨elasticsearch adduser esuser 4.ä¿®æ”¹elasticsearchå®‰è£…ç›®å½•çš„ç”¨æˆ· chown -R esuser:esuser /usr/local/elasticsearch 5.æœåŠ¡å™¨é…ç½®ä¿®æ”¹ ç”±äº Linux ç³»ç»Ÿå¯¹érootç”¨æˆ·é™åˆ¶äº†æ‰“å¼€çš„çº¿ç¨‹æ•°åŠæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ï¼Œå› æ­¤è¦å¯¹è¿™éƒ¨åˆ†é…ç½®è¿›è¡Œä¿®æ”¹ ä¿®æ”¹/etc/security/limits.conf åœ¨æ–‡ä»¶æœ«å°¾ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ esuser hard nofile 65536 esuser soft nofile 65536 esuser soft nproc 4096 esuser hard nproc 4096 ä¿®æ”¹/etc/sysctl.conf åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ å¦‚ä¸‹å†…å®¹ vm.max_map_count=262144 ç„¶åæ‰§è¡Œå‘½ä»¤ï¼Œä½¿ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆ sysctl -p ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹ä¸Šè¿°ä¸¤é¡¹ä¿®æ”¹åçš„ç»“æœ ulimit -a sysctl -a | grep vm.max_map_count 6.å¼€æ”¾ç«¯å£ # æŸ¥çœ‹å½“å‰å¼€æ”¾çš„ç«¯å£ firewall-cmd --list-all # è®¾ç½®å¼€æ”¾ç«¯å£å· firewall-cmd --add-port=9100/tcp --permanent firewall-cmd --add-port=9200/tcp --permanent firewall-cmd --add-port=9300/tcp --permanent # é‡å¯é˜²ç«å¢™ firewall-cmd --reload ä¸Šè¿°ä¸‰ä¸ªç«¯å£ï¼Œå°†åˆ†åˆ«ç”¨äºes headï¼Œes httpè®¿é—®ï¼Œesé›†ç¾¤å†…éƒ¨èŠ‚ç‚¹é€šä¿¡ï¼Œå› æ­¤éƒ½éœ€è¦æ‰“å¼€ 7.ä¿®æ”¹elasticsearch.ymlé…ç½® ç”±äºè¿™é‡Œéƒ¨ç½²çš„æ˜¯ä¸€ä¸ª elasticsearch é›†ç¾¤ï¼Œåœ¨å®Œæˆä¸Šè¿°é…ç½®ä¹‹åï¼Œéœ€åœ¨é›†ç¾¤éƒ¨ç½²çš„æœåŠ¡å™¨ä¸Šï¼Œä¿®æ”¹å„è‡ªçš„elasticsearch.ymlé…ç½®æ–‡ä»¶ã€‚ æ‰“å¼€åˆ° /usr/local/elasticsearch/config ç›®å½•ï¼Œä¿®æ”¹ elasticsearch.yml æ–‡ä»¶ã€‚ æˆ‘è¿™é‡Œéƒ¨ç½²çš„æ˜¯ä¸€ä¸ªåŒèŠ‚ç‚¹é›†ç¾¤ï¼Œä¸¤ä¸ªèŠ‚ç‚¹çš„ elasticsearch.yml æ–‡ä»¶å¦‚ä¸‹ èŠ‚ç‚¹1 cluster.name: elasticsearch node.name: es-node0 path.data: /home/elasticsearch/data path.logs: /home/elasticsearch/logs bootstrap.memory_lock: false bootstrap.system_call_filter: false network.host: 0.0.0.0 http.port: 9200 http.cors.enabled: true http.cors.allow-origin: &quot;*&quot; discovery.seed_hosts: [&quot;10.10.181.26&quot;, &quot;10.10.181.27&quot;] cluster.initial_master_nodes: [&quot;es-node0&quot;,&quot;es-node1&quot;] node.master: true node.data: true xpack.security.enabled: false èŠ‚ç‚¹2 cluster.name: elasticsearch node.name: es-node1 path.data: /home/elasticsearch/data path.logs: /home/elasticsearch/logs bootstrap.memory_lock: false bootstrap.system_call_filter: false network.host: 0.0.0.0 http.port: 9200 http.cors.enabled: true http.cors.allow-origin: &quot;*&quot; discovery.seed_hosts: [&quot;10.10.181.26&quot;, &quot;10.10.181.27&quot;] cluster.initial_master_nodes: [&quot;es-node0&quot;,&quot;es-node1&quot;] node.master: true node.data: true xpack.security.enabled: false 8.å¯åŠ¨elasticsearch åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šï¼Œåˆ‡æ¢åˆ° esuser ç”¨æˆ·ï¼Œæ‰“å¼€åˆ°å®‰è£…ç›®å½•çš„ bin æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œå¯åŠ¨å‘½ä»¤ su esuser cd /usr/local/elasticsearch/bin ./elasticsearch -d # å…³é—­es å‘½ä»¤ ps -ef|grep elasticsearch kill -9 è¿›ç¨‹å· æ³¨æ„ï¼šå¦‚æœä¸å°å¿ƒä»¥ root ç”¨æˆ·å¯åŠ¨äº†elasticsearchï¼Œéœ€è¦å…ˆåˆ é™¤ /home/elasticsearch/dataå’Œ/home/elasticsearch/logsè¿™ä¸¤ä¸ªç›®å½•ï¼Œç„¶ååˆ‡æ¢è‡³esuserç”¨æˆ·ï¼Œå†é‡æ–°å°è¯•å¯åŠ¨ 9.æŸ¥çœ‹å®‰è£…æƒ…å†µ æŸ¥çœ‹å®‰è£…æƒ…å†µ http://localhost:9200/ æŸ¥çœ‹eså®‰è£…çš„æ’ä»¶ http://localhost:9200/_cat/plugins æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€ http://localhost:9200/_cat/nodes?pretty æŸ¥çœ‹æ‰€æœ‰ç´¢å¼• http://localhost:9200/_cat/indices?v æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€ http://localhost:9200/_cat/health æŸ¥çœ‹å½“å‰ä¸»èŠ‚ç‚¹ http://localhost:9200/_cat/master 10. å®‰è£…åˆ†è¯å™¨å‘½ä»¤ æ‰“å¼€åˆ° bin ç›®å½•ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå°†ç‰ˆæœ¬æ›¿æ¢ä¸ºè‡ªå·±å®‰è£…çš„esç‰ˆæœ¬å·å³å¯ su esuser cd /usr/local/elasticsearch/bin ./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.0/elasticsearch-analysis-ik-7.9.0.zip ./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v7.9.0/elasticsearch-analysis-pinyin-7.9.0.zip 11. å…¶ä»–elasticsearch.ymlé‡è¦é…ç½® #é…ç½® ES çš„é›†ç¾¤åç§°ï¼Œé»˜è®¤å€¼æ˜¯ ESï¼Œå»ºè®®æ”¹æˆä¸æ‰€å­˜æ•°æ®ç›¸å…³çš„åç§°ï¼ŒES ä¼šè‡ªåŠ¨å‘ç°åœ¨åŒä¸€ç½‘æ®µä¸‹çš„é›†ç¾¤åç§°ç›¸åŒçš„èŠ‚ç‚¹ã€‚ cluster.nameï¼šelasticsearch #é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åï¼Œåœ¨åŒä¸€ä¸ªé›†ç¾¤ä¸­ä¸èƒ½é‡å¤ã€‚èŠ‚ç‚¹çš„åç§°ä¸€æ—¦è®¾ç½®ï¼Œå°±ä¸èƒ½å†æ”¹å˜äº†ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥è®¾ç½®æˆæœåŠ¡å™¨çš„ä¸»æœºåç§°ï¼Œä¾‹å¦‚ node.name:${HOSTNAME}ã€‚ node.namï¼š &quot;node1&quot; #æŒ‡å®šè¯¥èŠ‚ç‚¹æ˜¯å¦æœ‰èµ„æ ¼è¢«é€‰ä¸¾æˆä¸º Master èŠ‚ç‚¹ï¼Œé»˜è®¤æ˜¯ Trueï¼Œå¦‚æœè¢«è®¾ç½®ä¸º Trueï¼Œåˆ™åªæ˜¯æœ‰èµ„æ ¼æˆä¸º Master èŠ‚ç‚¹ï¼Œå…·ä½“èƒ½å¦æˆä¸º Master èŠ‚ç‚¹ï¼Œéœ€è¦é€šè¿‡é€‰ä¸¾äº§ç”Ÿã€‚ noed.masterï¼štrue #æŒ‡å®šè¯¥èŠ‚ç‚¹æ˜¯å¦å­˜å‚¨ç´¢å¼•æ•°æ®ï¼Œé»˜è®¤ä¸º Trueã€‚æ•°æ®çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥éƒ½æ˜¯åœ¨ Data èŠ‚ç‚¹å®Œæˆçš„ã€‚ node.dataï¼štrue #è®¾ç½®éƒ½ç´¢å¼•åˆ†ç‰‡ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯ 5 ç‰‡ã€‚ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºç´¢å¼•æ—¶è®¾ç½®è¯¥å€¼ï¼Œå…·ä½“è®¾ç½®ä¸ºå¤šå¤§éƒ½å€¼è¦æ ¹æ®æ•°æ®é‡çš„å¤§å°æ¥å®šã€‚å¦‚æœæ•°æ®é‡ä¸å¤§ï¼Œåˆ™è®¾ç½®æˆ 1 æ—¶æ•ˆç‡æœ€é«˜ã€‚ index.number_of_shardsï¼š5 #è®¾ç½®é»˜è®¤çš„ç´¢å¼•å‰¯æœ¬ä¸ªæ•°ï¼Œé»˜è®¤ä¸º 1 ä¸ªã€‚å‰¯æœ¬æ•°è¶Šå¤šï¼Œé›†ç¾¤çš„å¯ç”¨æ€§è¶Šå¥½ï¼Œä½†æ˜¯å†™ç´¢å¼•æ—¶éœ€è¦åŒæ­¥çš„æ•°æ®è¶Šå¤šã€‚ index.number_of_replicasï¼š1 #è®¾ç½®é…ç½®æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤æ˜¯ ES ç›®å½•ä¸‹çš„ Conf æ–‡ä»¶å¤¹ã€‚å»ºè®®ä½¿ç”¨é»˜è®¤å€¼ã€‚ path.confï¼š/path/to/conf #è®¾ç½®ç´¢å¼•æ•°æ®å¤šå­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤æ˜¯ ES æ ¹ç›®å½•ä¸‹çš„ Data æ–‡ä»¶å¤¹ã€‚åˆ‡è®°ä¸è¦ä½¿ç”¨é»˜è®¤å€¼ï¼Œå› ä¸ºè‹¥ ES è¿›è¡Œäº†å‡çº§ï¼Œåˆ™æœ‰å¯èƒ½æ•°æ®å…¨éƒ¨ä¸¢å¤±ã€‚ å¯ä»¥ç”¨åŠè§’é€—å·éš”å¼€è®¾ç½®çš„å¤šä¸ªå­˜å‚¨è·¯å¾„ï¼Œåœ¨å¤šç¡¬ç›˜çš„æœåŠ¡å™¨ä¸Šè®¾ç½®å¤šä¸ªå­˜å‚¨è·¯å¾„æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ path.dataï¼š/path/to/data1,/path/to/data2 #è®¾ç½®æ—¥å¿—æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤æ˜¯ ES æ ¹ç›®å½•ä¸‹çš„ Logsï¼Œå»ºè®®ä¿®æ”¹åˆ°å…¶ä»–åœ°æ–¹ã€‚ path.logsï¼š/path/to/logs #è®¾ç½®ç¬¬ä¸‰æ–¹æ’ä»¶çš„å­˜æ”¾è·¯å¾„ï¼Œé»˜è®¤æ˜¯ ES æ ¹ç›®å½•ä¸‹çš„ Plugins æ–‡ä»¶å¤¹ã€‚ path.pluginsï¼š/path/to/plugins #è®¾ç½®ä¸º True æ—¶å¯é”ä½å†…å­˜ã€‚å› ä¸ºå½“ JVM å¼€å§‹ Swap æ—¶ï¼ŒES çš„æ•ˆç‡ä¼šé™ä½ï¼Œæ‰€ä»¥è¦ä¿è¯å®ƒä¸ Swapã€‚ bootstrap.mlockallï¼štrue #è®¾ç½®æœ¬èŠ‚ç‚¹ç»‘å®šçš„ IP åœ°å€ï¼ŒIP åœ°å€ç±»å‹æ˜¯ IPv4 æˆ– IPv6ï¼Œé»˜è®¤ä¸º 0.0.0.0ã€‚ network.bind_hostï¼š192.168.0.1 #è®¾ç½®å…¶ä»–èŠ‚ç‚¹å’Œè¯¥èŠ‚ç‚¹äº¤äº’çš„ IP åœ°å€ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œåˆ™ä¼šè¿›è¡Œè‡ªæˆ‘åˆ¤æ–­ã€‚ network.publish_hostï¼š192.168.0.1 #ç”¨äºåŒæ—¶è®¾ç½® bind_host å’Œ publish_host è¿™ä¸¤ä¸ªå‚æ•°ã€‚ network.hostï¼š192.168.0.1 #è®¾ç½®å¯¹å¤–æœåŠ¡çš„ HTTP ç«¯å£ï¼Œé»˜è®¤ä¸º 9200ã€‚ES çš„èŠ‚ç‚¹éœ€è¦é…ç½®ä¸¤ä¸ªç«¯å£å·ï¼Œä¸€ä¸ªå¯¹å¤–æä¾›æœåŠ¡çš„ç«¯å£å·ï¼Œä¸€ä¸ªæ˜¯é›†ç¾¤å†…éƒ¨ä½¿ç”¨çš„ç«¯å£å·ã€‚ http.port è®¾ç½®çš„æ˜¯å¯¹å¤–æä¾›æœåŠ¡çš„ç«¯å£å·ã€‚æ³¨æ„ï¼Œå¦‚æœåœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šé…ç½®å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ™åˆ‡è®°å¯¹ç«¯å£å·è¿›è¡ŒåŒºåˆ†ã€‚ http.portï¼š9200 #è®¾ç½®é›†ç¾¤å†…éƒ¨çš„èŠ‚ç‚¹é—´äº¤äº’çš„ TCP ç«¯å£ï¼Œé»˜è®¤æ˜¯ 9300ã€‚æ³¨æ„ï¼Œå¦‚æœåœ¨ä¸€ä¸ªæœåŠ¡å™¨é…ç½®å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ™åˆ‡è®°å¯¹ç«¯å£å·è¿›è¡ŒåŒºåˆ†ã€‚ transport.tcp.portï¼š9300 #è®¾ç½®åœ¨èŠ‚ç‚¹é—´ä¼ è¾“æ•°æ®æ—¶æ˜¯å¦å‹ç¼©ï¼Œé»˜è®¤ä¸º Falseï¼Œä¸å‹ç¼©ã€‚ transport.tcp.compressï¼štrue #è®¾ç½®åœ¨é€‰ä¸¾ Master èŠ‚ç‚¹æ—¶éœ€è¦å‚ä¸çš„æœ€å°‘çš„å€™é€‰ä¸»èŠ‚ç‚¹æ•°ï¼Œé»˜è®¤ä¸º 1ã€‚å¦‚æœä½¿ç”¨é»˜è®¤å€¼ï¼Œåˆ™å½“ç½‘ç»œä¸ç¨³å®šæ—¶æœ‰å¯èƒ½ä¼šå‡ºç°è„‘è£‚ã€‚ åˆç†çš„æ•°å€¼ä¸º(master_eligible_nodes/2)+1ï¼Œå…¶ä¸­ master_eligible_nodes è¡¨ç¤ºé›†ç¾¤ä¸­çš„å€™é€‰ä¸»èŠ‚ç‚¹æ•°ã€‚ discovery.zen.minimum_master_nodesï¼š1 #è®¾ç½®åœ¨é›†ç¾¤ä¸­è‡ªåŠ¨å‘ç°å…¶ä»–èŠ‚ç‚¹æ—¶ Ping è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 3 ç§’ã€‚ åœ¨è¾ƒå·®çš„ç½‘ç»œç¯å¢ƒä¸‹éœ€è¦è®¾ç½®å¾—å¤§ä¸€ç‚¹ï¼Œé˜²æ­¢å› è¯¯åˆ¤è¯¥èŠ‚ç‚¹çš„å­˜æ´»çŠ¶æ€è€Œå¯¼è‡´åˆ†ç‰‡çš„è½¬ç§»ã€‚ discovery.zen.ping.timeoutï¼š3s åŸºäºSpringbootä½¿ç”¨ 1. å¼•å…¥ä¾èµ– &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt; &lt;/dependency&gt; 2.é…ç½® elasticsearch é›†ç¾¤åœ°å€ spring.elasticsearch.uris=http://10.10.181.26:9200,http://10.10.181.27:9200 3.åˆ›å»ºç´¢å¼•å®ä½“ç±» @Document(indexName = &quot;demo&quot;) @Setting(replicas = 2,shards = 2) @Data public class MyEsDemo { /** * æµ‹è¯•ä½¿ç”¨idæŸ¥è¯¢çš„ç›¸å…³è¯­å¥ */ @Id @Field(type = FieldType.Long) private Long id; /** * ç®€å•çš„textç±»å‹ */ @Field(type = FieldType.Text) private String normalText1; /** * ç®€å•çš„textç±»å‹ */ @Field(type = FieldType.Text) private String normalText2; /** * å°†normalText1å’ŒnormalText2ç»„åˆèµ·æ¥ */ @Field(type = FieldType.Text) private String combineText; /** * ç®€å•çš„keywordç±»å‹ */ @Field(type = FieldType.Keyword) private String normalKeyword; /** * æ—¢å»ºç´¢å¼•æ—¶ç”¨ ik_max_word å°½å¯èƒ½å¤šçš„åˆ†è¯ï¼Œè€Œæœç´¢æ—¶ç”¨ ik_smart å°½å¯èƒ½æé«˜åŒ¹é…å‡†åº¦ï¼Œè®©ç”¨æˆ·çš„æœç´¢å°½å¯èƒ½çš„å‡†ç¡® */ @Field(type = FieldType.Text,analyzer = &quot;ik_max_word&quot;,searchAnalyzer = &quot;ik_smart&quot;) private String analyzeText; /** * æŒ‡å®šæ—¥æœŸæ ¼å¼ */ @Field(type = FieldType.Date, format = DateFormat.date_hour_minute_second) private Date date; /** * Booleanç±»å‹çš„å€¼ */ @Field(type = FieldType.Boolean) private Boolean boolVal; /** * Double ç±»å‹çš„å€¼ */ @Field(type = FieldType.Double) private Double doubleVal; /** * List ç±»å‹çš„å€¼ */ @Field(type = FieldType.Text) private List&lt;String&gt; list; } 4. åŸºç¡€CRUD 1.æ–°å¢ @Service // ä½¿ç”¨lombokæ­¤æ³¨è§£ä¹‹åï¼ŒAutowired çš„å¯¹è±¡å¿…é¡»æ˜¯finalæˆ–è€…æ˜¯@NotNull @RequiredArgsConstructor(onConstructor = @__(@Autowired)) @Slf4j public class AddService { @Autowired private final ElasticsearchRestTemplate template; @Autowired private final MyEsDemoRepository repository; @Autowired private final RestHighLevelClient client; @Autowired private final SnowflakeIdUtil snowflakeIdUtil; /** * ä½¿ç”¨ElasticsearchRestTemplateæ–°å¢ * @param demo */ public void addByTemplate(MyEsDemo demo) { template.setRefreshPolicy(RefreshPolicy.IMMEDIATE); template.save(demo); } /** * ä½¿ç”¨ElasticsearchRestTemplateæ‰¹é‡æ–°å¢ * @param list */ public void addBatchByTemplate(List&lt;MyEsDemo&gt; list) { template.setRefreshPolicy(RefreshPolicy.IMMEDIATE); template.save(list); } /** * ä½¿ç”¨Repositoryæ–°å¢ * @param demo */ public void addByRepository(MyEsDemo demo) { repository.save(demo); } /** * ä½¿ç”¨Repositoryæ‰¹é‡æ–°å¢ * @param list */ public void addBatchByRepository(List&lt;MyEsDemo&gt; list) { repository.saveAll(list); } /** * ä½¿ç”¨RestClientæ–°å¢ * @param demo */ public void addByRestClient(MyEsDemo demo) { String indexName = demo.getClass().getAnnotation(Document.class).indexName(); IndexRequest indexRequest = new IndexRequest(indexName); indexRequest.id(String.valueOf(snowflakeIdUtil.nextId())); indexRequest.source(JSON.toJSONString(demo), XContentType.JSON); try { client.index(indexRequest, RequestOptions.DEFAULT); } catch (IOException e) { log.error(&quot;ä¿å­˜å¤±è´¥&quot;); } } /** * ä½¿ç”¨RestClientæ‰¹é‡æ–°å¢ * @param list */ public void addBatchByRestClient(List&lt;MyEsDemo&gt; list) { if (CollectionUtils.isEmpty(list)) { return; } String indexName = list.get(0).getClass().getAnnotation(Document.class).indexName(); BulkRequest request = new BulkRequest(); for (MyEsDemo demo : list) { request.add(new IndexRequest(indexName) .id(String.valueOf(snowflakeIdUtil.nextId())) .source(JSONObject.toJSONString(demo), XContentType.JSON) ); } try { client.bulk(request,RequestOptions.DEFAULT); } catch (IOException e) { throw new RuntimeException(e); } } } 2.åˆ é™¤ @Service @RequiredArgsConstructor(onConstructor = @__(@Autowired)) @Slf4j public class DeleteService { @Autowired private final ElasticsearchRestTemplate template; @Autowired private final MyEsDemoRepository repository; @Autowired private final RestHighLevelClient client; /** * ä½¿ç”¨Templateåˆ é™¤ * @param demo */ public void deleteByTemplate(MyEsDemo demo) { template.setRefreshPolicy(RefreshPolicy.IMMEDIATE); template.delete(demo); } /** * ä½¿ç”¨Templateæ‰¹é‡åˆ é™¤ * @param list */ public void deleteBatchByTemplate(List&lt;MyEsDemo&gt; list) { template.setRefreshPolicy(RefreshPolicy.IMMEDIATE); for (MyEsDemo demo : list) { template.delete(demo); } } /** * ä½¿ç”¨Templateæ ¹æ®æŸ¥è¯¢æ¡ä»¶åˆ é™¤ */ public void queryDeleteByTemplate() { NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder(); builder.withQuery(QueryBuilders.matchQuery(&quot;id&quot;,1)); template.delete(builder.build(), MyEsDemo.class); } /** * ä½¿ç”¨Repositoryåˆ é™¤ * @param demo */ public void deleteByRepository(MyEsDemo demo) { repository.deleteById(demo.getId()); } /** * ä½¿ç”¨Repositoryæ‰¹é‡åˆ é™¤ * @param list */ public void deleteBatchByRepository(List&lt;MyEsDemo&gt; list) { List&lt;Long&gt; idList = list.stream().map(MyEsDemo::getId).collect(Collectors.toList()); repository.deleteAllById(idList); } /** * ä½¿ç”¨RestClientåˆ é™¤ * @param demo * @throws IOException */ public void deleteByRestClient(MyEsDemo demo) throws IOException { String indexName = demo.getClass().getAnnotation(Document.class).indexName(); DeleteRequest deleteRequest = new DeleteRequest(indexName, String.valueOf(demo.getId())); client.delete(deleteRequest, RequestOptions.DEFAULT); } /** * ä½¿ç”¨RestClientæ‰¹é‡åˆ é™¤ * @param list * @throws IOException */ public void deleteBatchByRestClient(List&lt;MyEsDemo&gt; list) throws IOException { BulkRequest bulkRequest = new BulkRequest(); list.forEach(e-&gt;{ DeleteRequest deleteRequest = new DeleteRequest(&quot;demo&quot;, String.valueOf(e.getId())); bulkRequest.add(deleteRequest); }); client.bulk(bulkRequest,RequestOptions.DEFAULT); } /** * ä½¿ç”¨RestClientæ¡ä»¶æŸ¥è¯¢åˆ é™¤ * @throws IOException */ public void queryDeleteByRestClient() throws IOException { DeleteByQueryRequest request = new DeleteByQueryRequest(&quot;sub_bank1031&quot;); request.setQuery(QueryBuilders.matchQuery(&quot;id&quot;,1)); client.deleteByQuery(request, RequestOptions.DEFAULT); } } 3.ä¿®æ”¹ @Service @RequiredArgsConstructor(onConstructor = @__(@Autowired)) @Slf4j public class UpdateService { @Autowired private final ElasticsearchRestTemplate template; @Autowired private final RestHighLevelClient client; /** * ä½¿ç”¨Templateçš„saveæ–¹æ³•è¿›è¡Œæ›´æ–°ï¼Œè¯¥æ–¹æ³•ä¼šè¦†ç›–ä¼šå°†idç›¸ç­‰æ•°æ®çš„æ‰€æœ‰å­—æ®µå‡æ›¿æ¢ä¸ºæ–°ä¼ å…¥å¯¹è±¡çš„å­—æ®µå€¼ï¼Œnullä¹Ÿä¼šè¦†ç›–ï¼Œè‹¥idä¸åŒ¹é…ï¼Œåˆ™æ–°å¢ * @param demo */ public void updateByTemplateSave(MyEsDemo demo) { template.save(demo); } /** * ä½¿ç”¨Templateè¿›è¡Œupdateï¼Œæ³¨æ„withDocAsUpsertå±æ€§ * @param demo */ public void updateByTemplate(MyEsDemo demo) { Document document = Document.create(); document.fromJson(JSON.toJSONString(demo)); UpdateQuery query = UpdateQuery .builder(String.valueOf(demo.getId())) .withDocument(document) // æ–‡æ¡£ä¸å­˜åœ¨æ—¶æ’å…¥ .withDocAsUpsert(true) .build(); template.update(query, IndexCoordinates.of(&quot;demo&quot;)); } /** * ä½¿ç”¨Templateè¿›è¡Œæ‰¹é‡æ›´æ–° * @param list */ public void updateBatchByTemplate(List&lt;MyEsDemo&gt; list) { List&lt;UpdateQuery&gt; updateQueryList = new ArrayList&lt;&gt;(); for (MyEsDemo demo : list) { Document document = Document.create(); document.fromJson(JSON.toJSONString(demo)); UpdateQuery query = UpdateQuery .builder(String.valueOf(demo.getId())) .withDocument(document) // æ–‡æ¡£ä¸å­˜åœ¨æ—¶æ’å…¥ .withDocAsUpsert(true) .build(); updateQueryList.add(query); } template.bulkUpdate(updateQueryList,MyEsDemo.class); } /** * ä½¿ç”¨Templateè¿›è¡Œæ¡ä»¶æŸ¥è¯¢æ›´æ–°ï¼Œè¯¥æ–¹æ³•å°†æ˜¯çš„æŸ¥è¯¢åˆ°çš„å¯¹è±¡ä¸­ï¼ŒDocumentä¸­æŒ‡å®šçš„å­—æ®µéƒ½è¢«æ›´æ–°ä¸ºå¯¹åº”å€¼ */ public void queryUpdateByTemplate() { NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder(); queryBuilder.withQuery(QueryBuilders.matchQuery(&quot;id&quot;,1)); Document document = Document.create(); document.put(&quot;normalText1&quot;,&quot;ä½¿ç”¨esTemplateè¿›è¡Œæ¡ä»¶æŸ¥è¯¢æ›´æ–°&quot;); // æ¡ä»¶æ›´æ–°ï¼Œå°†å…¶normalText1å­—æ®µè¿›è¡Œæ›´æ–° UpdateQuery query = UpdateQuery .builder(queryBuilder.build()) .withDocument(document) .build(); template.updateByQuery(query,IndexCoordinates.of(&quot;demo&quot;)); } /** * ä½¿ç”¨RestClientè¿›è¡Œæ›´æ–° * @param demo * @throws IOException */ public void updateByRestClient(MyEsDemo demo) throws IOException { UpdateRequest updateRequest = new UpdateRequest(&quot;demo&quot;, String.valueOf(demo.getId())); Document document = Document.create(); document.fromJson(JSON.toJSONString(demo)); updateRequest.doc(document); client.update(updateRequest, RequestOptions.DEFAULT); } /** * ä½¿ç”¨RestClientè¿›è¡Œæ‰¹é‡æ›´æ–° * @param list * @throws IOException */ public void batchUpdateByRestClient(List&lt;MyEsDemo&gt; list) throws IOException { BulkRequest bulkRequest = new BulkRequest(); list.forEach(e-&gt;{ //è·å–id UpdateRequest updateRequest = new UpdateRequest(); updateRequest.index(&quot;demo&quot;); // trueï¼Œè¡¨æ˜å¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼Œåˆ™æ–°æ›´æ–°çš„æ–‡æ¡£å†…å®¹ä½œä¸ºæ–°çš„å†…å®¹æ’å…¥æ–‡æ¡£ï¼Œè¿™ä¸ªå’ŒscriptedUpsertçš„åŒºåˆ«æ˜¯ï¼šæ›´æ–°æ–‡æ¡£çš„ä¸¤ç§ä¸åŒæ–¹å¼ï¼Œæœ‰çš„ä½¿ç”¨docæ–¹æ³•æ›´æ–°æœ‰çš„ä½¿ç”¨è„šæœ¬æ›´æ–° updateRequest.docAsUpsert(true); //æ›´æ–°çš„id updateRequest.id(String.valueOf(e.getId())); //æ›´æ–°çš„æ•°æ® Document document = Document.create(); document.fromJson(JSON.toJSONString(e)); updateRequest.doc(document); bulkRequest.add(updateRequest); }); client.bulk(bulkRequest,RequestOptions.DEFAULT); } /** * ä½¿ç”¨RestClientæ¡ä»¶æŸ¥è¯¢æ›´æ–° * å°†ä½¿ç”¨QueryBuilderä¸­çš„æ¡ä»¶è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶å°†Documentä¸­æŒ‡å®šçš„å­—æ®µéƒ½è¢«æ›´æ–°ä¸ºå¯¹åº”å€¼ * @throws IOException */ public void queryUpdateByRestClient() throws IOException { //æŸ¥è¯¢æ¡ä»¶å¦‚æœæ˜¯andå…³ç³»ä½¿ç”¨must å¦‚ä½•æ˜¯orå…³ç³»ä½¿ç”¨should BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery() .must(QueryBuilders.termQuery(&quot;id&quot;,&quot;1&quot;)) .should(QueryBuilders.rangeQuery(&quot;doubleVal&quot;).gt(1d)); Document document = Document.create(); document.put(&quot;normalText1&quot;,&quot;ä½¿ç”¨restClientè¿›è¡Œæ¡ä»¶æŸ¥è¯¢æ›´æ–°&quot;); UpdateByQueryRequest request = getUpdateRequst(&quot;demo&quot;, boolQueryBuilder, document); client.updateByQuery(request,RequestOptions.DEFAULT); } /** * æ„å»ºUpdateByQueryRequest * @param index * @param query * @param document * @return */ public UpdateByQueryRequest getUpdateRequst(String index, QueryBuilder query, Document document) { UpdateByQueryRequest updateByQueryRequest = new UpdateByQueryRequest(index); //è®¾ç½®åˆ†ç‰‡å¹¶è¡Œ updateByQueryRequest.setSlices(2); //è®¾ç½®ç‰ˆæœ¬å†²çªæ—¶ç»§ç»­æ‰§è¡Œ updateByQueryRequest.setConflicts(&quot;proceed&quot;); //è®¾ç½®æ›´æ–°å®Œæˆååˆ·æ–°ç´¢å¼• pså¾ˆé‡è¦å¦‚æœä¸åŠ å¯èƒ½æ•°æ®ä¸ä¼šå®æ—¶åˆ·æ–° updateByQueryRequest.setRefresh(true); updateByQueryRequest.setQuery(query); StringBuilder script = new StringBuilder(); Set&lt;String&gt; keys = document.keySet(); for (String key : keys) { String appendValue = &quot;&quot;; Object value = document.get(key); if (value instanceof Number) { appendValue = value.toString(); } else if (value instanceof String) { appendValue = &quot;'&quot; + value.toString() + &quot;'&quot;; } else if (value instanceof List){ appendValue = JSON.toJSONString(value); } else { appendValue = value.toString(); } script.append(&quot;ctx._source.&quot;).append(key).append(&quot;=&quot;).append(appendValue).append(&quot;;&quot;); } updateByQueryRequest.setScript(new Script(script.toString())); return updateByQueryRequest; } } 4.æŸ¥è¯¢ï¼ˆå¾…å®Œå–„ï¼‰ @Service @RequiredArgsConstructor(onConstructor = @__(@Autowired)) @Slf4j public class SearchService { @Autowired private final ElasticsearchRestTemplate template; @Autowired private final MyEsDemoRepository repository; @Autowired private final RestHighLevelClient client; @Autowired private final EsUtil esUtil; /** * ä½¿ç”¨Templateè¿›è¡Œæ¡ä»¶æœç´¢ * @return */ List&lt;MyEsDemo&gt; searchByTemplate() { NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder(); // æ¡ä»¶ç­›é€‰ï¼Œä½¿ç”¨QueryBuildersç¬¦åˆéœ€æ±‚çš„æŸ¥è¯¢æ¡ä»¶ builder.withQuery(QueryBuilders.matchQuery(&quot;id&quot;,1)); builder.withQuery(QueryBuilders.rangeQuery(&quot;doubleVal&quot;).gt(1d)); builder.withQuery(QueryBuilders.boolQuery().must(QueryBuilders.termQuery(&quot;boolVal&quot;,true))); // æ’åº builder.withSorts(SortBuilders.fieldSort(&quot;id&quot;).order(SortOrder.ASC)); // åˆ†é¡µ Pageable pageable = PageRequest.of(1, 5); builder.withPageable(pageable); // æŸ¥è¯¢ç»“æœ return esUtil.getHitResult(builder, MyEsDemo.class); } /** * ä½¿ç”¨Repositoryè¿›è¡Œæ¡ä»¶æœç´¢ * @return */ List&lt;MyEsDemo&gt; searchByRepository(Long id) { return repository.findAllByIdEquals(id); } /** * ä½¿ç”¨RestClientè¿›è¡Œæ¡ä»¶æœç´¢ * @return */ List&lt;MyEsDemo&gt; searchByRestClient() throws IOException { SearchScrollRequest request = new SearchScrollRequest(); client.scroll(request, RequestOptions.DEFAULT); return null; } } 5.ä½¿ç”¨ä¸­çš„é—®é¢˜ 1. åˆ†é¡µå¤§å°é™åˆ¶ org.elasticsearch.ElasticsearchStatusException: Elasticsearch exception [type=search_phase_execution_exception, reason=all shards failed] Caused by: org.elasticsearch.client.ResponseException: method [POST], host [http://**.***.**.***:****], URI [/****/****/_search?typed_keys=true&amp;ignore_unavailable=false&amp;expand_wildcards=open&amp;allow_no_indices=true&amp;search_type=query_then_fetch&amp;batched_reduce_size=512], status line [HTTP/1.1 500 Internal Server Error] {&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;query_phase_execution_exception&quot;,&quot;reason&quot;:&quot;Result window is too large, from + size must be less than or equal to: [10000] but was [100001]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.&quot;}],&quot;type&quot;:&quot;search_phase_execution_exception&quot;,&quot;reason&quot;:&quot;all shards failed&quot;,&quot;phase&quot;:&quot;query&quot;,&quot;grouped&quot;:true,&quot;failed_shards&quot;:[{&quot;shard&quot;:0,&quot;index&quot;:&quot;dms-apply-info&quot;,&quot;node&quot;:&quot;IZhu6TvHSh-jm0rinE0f2A&quot;,&quot;reason&quot;:{&quot;type&quot;:&quot;query_phase_execution_exception&quot;,&quot;reason&quot;:&quot;Result window is too large, from + size must be less than or equal to: [10000] but was [100001]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.&quot;}}]},&quot;status&quot;:500} ä»ä¸Šè¿°æŠ¥é”™ä¿¡æ¯å¯çŸ¥ï¼Œåˆ†é¡µæ—¶ï¼Œå½“from+size &gt; 10000æ—¶ï¼Œeså°†æŠ¥é”™è¾¾åˆ°æ•°é‡é™åˆ¶ã€‚ é€šå¸¸æ¥è¯´æ˜¯æ²¡æœ‰ç”¨æˆ·ä¼šç¿»é¡µç¿»åˆ°10000æ¡çš„ï¼Œä½†æ˜¯ä»¥é˜²ä¸‡ä¸€ï¼Œæä¾›å¦‚ä¸‹ä¸¤ç§è§£å†³æ–¹æ¡ˆ **ä¿®æ”¹ max_result_window ** åœ¨ elasticsearch.yml æ–‡ä»¶ä¸‹æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œç„¶åé‡å¯ max_result_window: 200000000 é‡‡ç”¨scrollçš„æ–¹å¼æ·±åº¦åˆ†é¡µ åˆ›å»ºscrollæŸ¥è¯¢ç»“æœçš„å°è£…å¯¹è±¡ public class EsPageContent&lt;T&gt; { private SearchScrollHits&lt;T&gt; hit; private ElasticsearchRestTemplate template; private String indexName; private Class&lt;T&gt; c; List&lt;String&gt; scrollIds = new ArrayList&lt;&gt;(); /** * æ˜¯å¦æœ‰æ•°æ® * @return */ public boolean hasNext() { return this.hit.hasSearchHits(); } /** * è·å–ä¸‹ä¸€ä¸ªscrollä¸­çš„æ•°æ® * @return */ public List&lt;T&gt; getNext() { String scrollId = this.hit.getScrollId(); this.scrollIds.add(scrollId); List&lt;SearchHit&lt;T&gt;&gt; data = this.hit.getSearchHits(); List&lt;T&gt; result = data.stream().map(SearchHit::getContent).collect(Collectors.toList()); // åç»­æŸ¥è¯¢ this.hit = template.searchScrollContinue(scrollId, 60 * 1000, this.c,IndexCoordinates.of(this.indexName)); return result; } /** * æ¸…é™¤scrollæ¸¸æ ‡ */ public void clearScrollIds() { this.template.searchScrollClear(scrollIds); } public void setHit(SearchScrollHits&lt;T&gt; hit) { this.hit = hit; } public void setTemplate(ElasticsearchRestTemplate template) { this.template = template; } public void setIndexName(String indexName) { this.indexName = indexName; } public void setC(Class&lt;T&gt; c) { this.c = c; } } åˆ›å»ºEsUtil @Component public class EsUtil { @Autowired private ElasticsearchRestTemplate template; /** * è·å–esæ•°æ®åˆ†é¡µå¯¹è±¡ * @param query * @param c * @return * @param &lt;T&gt; */ public &lt;T&gt; EsPageContent&lt;T&gt; getPageData(NativeSearchQuery query, Class&lt;T&gt; c) { // è®¾ç½®æ¯é¡µæ•°æ®é‡ String indexName = c.getAnnotation(Document.class).indexName(); query.setMaxResults(PageSizeConst.ES_PAGE); SearchScrollHits&lt;T&gt; searchHits = template.searchScrollStart(60 * 1000, query, c, IndexCoordinates.of(indexName)); EsPageContent&lt;T&gt; content = new EsPageContent&lt;&gt;(); content.setIndexName(indexName); content.setC(c); content.setHit(searchHits); content.setTemplate(template); return content; } /** * esæ¡ä»¶æŸ¥è¯¢ * @param builder * @param c * @return * @param &lt;T&gt; */ public &lt;T&gt; List&lt;T&gt; listSearchResult(NativeSearchQueryBuilder builder,Class&lt;T&gt; c) { List&lt;T&gt; list = new ArrayList&lt;&gt;(); SearchHits&lt;T&gt; search = template.search(builder.build(), c); if (search.getTotalHits() &gt; 0) { List&lt;T&gt; result = search.stream().map(SearchHit::getContent).collect(Collectors.toList()); list.addAll(result); } return list; } } ä½¿ç”¨ EsPageContent&lt;EsSecurityBasicInfo&gt; content = esUtil.getPageData(nativeSearchQuery, EsSecurityBasicInfo.class); while (content.hasNext()) { List&lt;EsSecurityBasicInfo&gt; list = content.getNext(); // to do } 2. æœç´¢æ—¶åŒ…å«ç©ºæ ¼æŠ¥é”™ ä½¿ç”¨ Es Repository è¿›è¡Œæœç´¢æ—¶ï¼Œå¦‚æœä¼ å…¥çš„å­—ç¬¦ä¸²ä¸­åŒ…å«ç©ºæ ¼ï¼Œä¼šå¯¼è‡´esæŠ¥é”™ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ String çš„ replaceAll å’Œ trim æ–¹æ³•ï¼Œå°†æ‰€æœ‰ç©ºæ ¼å»é™¤ 3. Textå’ŒKeywordçš„ä½¿ç”¨ ","link":"https://kololantoo.github.io/post/elasticsearch-an-zhuang-he-ji-yu-springboot-shi-yong/"},{"title":"Hello Gridea","content":"ğŸ‘ æ¬¢è¿ä½¿ç”¨ Gridea ï¼ âœï¸ Gridea ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ... Github Gridea ä¸»é¡µ ç¤ºä¾‹ç½‘ç«™ ç‰¹æ€§ğŸ‘‡ ğŸ“ ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ Markdown è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ ğŸŒ‰ ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡ ğŸ·ï¸ ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„ ğŸ“‹ ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå• ğŸ’» ä½ å¯ä»¥åœ¨ Windowsï¼ŒMacOS æˆ– Linux è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯ ğŸŒ ä½ å¯ä»¥ä½¿ç”¨ ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ æˆ– Coding Pages å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å° ğŸ’¬ ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ Gitalk æˆ– DisqusJS è¯„è®ºç³»ç»Ÿ ğŸ‡¬ğŸ‡§ ä½ å¯ä»¥ä½¿ç”¨ä¸­æ–‡ç®€ä½“æˆ–è‹±è¯­ ğŸŒ ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ› ğŸ–¥ ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥ ğŸŒ± å½“ç„¶ Gridea è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´ å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼ ğŸ˜˜ Enjoy~ ","link":"https://kololantoo.github.io/post/hello-gridea/"}]}